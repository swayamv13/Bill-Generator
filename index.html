<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Invoice / Patient Bill Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0b63d6;
      --primary-dark: #084aa3;
      --bg: #f2f4f7;
      --surface: #ffffff;
      --text: #1f2937;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    /* Layout */
    .app-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (min-width: 1024px) {
      .app-container {
        grid-template-columns: 380px 1fr;
        padding: 32px;
        align-items: start;
      }
    }

    /* Controls Section */
    .controls {
      background: var(--surface);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 10;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 16px;
      position: relative;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #f9fafb;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(11, 99, 214, 0.1);
      background: #fff;
    }

    /* Custom Autocomplete */
    .suggestions-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 50;
      display: none;
    }

    .suggestions-list.active {
      display: block;
    }

    .suggestion-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.95rem;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover {
      background: #eff6ff;
      color: var(--primary);
    }

    .suggestion-item strong {
      color: var(--primary-dark);
    }

    .suggestion-price {
      float: right;
      color: var(--text-muted);
      font-size: 0.85rem;
    }


    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      height: 48px;
      gap: 8px;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-secondary {
      background: white;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-dark {
      background: #1f2937;
      color: white;
    }

    .action-bar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    @media (min-width: 640px) {
      .action-bar {
        display: grid;
        grid-template-columns: 1fr 1fr;
      }

      .action-bar .full-width {
        grid-column: span 2;
      }
    }

    /* Add Item Section */
    .add-item-box {
      background: #f8fafc;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
      position: relative;
    }

    /* Invoice Preview */
    .invoice-preview-wrapper {
      width: 100%;
      background: #525659;
      padding: 20px;
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      min-height: 200px;
    }

    .zoom-controls {
      width: 100%;
      max-width: 800px;
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
      color: #fff;
      font-size: 12px;
      gap: 10px;
    }

    /* 
       ACTUAL INVOICE STYLES 
    */
    .invoice {
      background: #fff;
      padding: 40px;
      width: 800px;
      /* A4 Height Fix */
      min-height: 1100px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      font-family: 'Times New Roman', Times, serif;
      color: #000;
      box-sizing: border-box;
      transform-origin: top center;
    }

    /* This pushes the footer to the bottom */
    .invoice-bottom {
      margin-top: auto;
    }

    .header {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 20px;
      border-bottom: 4px solid #cfa93e;
      padding-bottom: 15px;
      margin-bottom: 20px;
      align-items: center;
    }

    .header img {
      height: 80px;
      width: auto;
      object-fit: contain;
    }

    .header-info h1 {
      color: #11114c;
      margin: 0;
      font-size: 26px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .header-info span {
      display: inline-block;
      color: rgb(250, 147, 2);
      font-size: 18px;
      font-weight: bold;
      border-bottom: 2px solid rgb(250, 147, 2);
      margin-bottom: 4px;
    }

    .header-info p {
      margin: 3px 0;
      font-size: 14px;
      line-height: 1.4;
      color: #333;
    }

    .meta-grid {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f8f8;
      padding: 12px 15px;
      border: 1px solid #ddd;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .meta-grid div {
      font-weight: bold;
    }

    .meta-grid span {
      font-weight: normal;
      margin-left: 8px;
    }

    .patient-details {
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
    }

    .patient-details p {
      margin: 4px 0;
    }

    .patient-details strong {
      min-width: 80px;
      display: inline-block;
    }

    table.items {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    table.items th,
    table.items td {
      border: 1px solid #888;
      padding: 12px 8px;
      vertical-align: middle;
    }

    table.items th {
      background: #f0f0f0;
      text-align: left;
      font-weight: bold;
      color: #000;
    }

    .col-desc {
      text-align: left;
    }

    .col-rate {
      text-align: right;
      width: 15%;
      white-space: nowrap;
    }

    .col-qty {
      text-align: center;
      width: 10%;
      white-space: nowrap;
    }

    .col-amt {
      text-align: right;
      width: 18%;
      white-space: nowrap;
      font-weight: bold;
    }

    .col-act {
      text-align: center;
      width: 8%;
    }

    .right {
      text-align: right;
    }

    .center {
      text-align: center;
    }

    .totals-section {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .totals-table {
      width: 320px;
      border-collapse: collapse;
    }

    .totals-table td {
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .totals-table tr:last-child {
      background: #f9f9f9;
    }

    .qr-section {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-top: 50px;
      border-top: 2px solid #cfa93e;
      padding-top: 20px;
    }

    .qr-section img {
      height: 110px;
      width: 110px;
      border: 1px solid #eee;
    }

    .qr-text p {
      margin: 5px 0;
      font-size: 13px;
      font-weight: bold;
    }

    .inv-footer {
      margin-top: 40px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 12px;
    }

    @media print {
      body {
        background: white;
        padding: 0;
      }

      .app-container {
        display: block;
        max-width: none;
        padding: 0;
        margin: 0;
      }

      .controls,
      .invoice-preview-wrapper,
      .zoom-controls {
        display: none;
      }

      .invoice {
        display: flex !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        margin: 0;
        padding: 40px;
        border: none;
        box-shadow: none;
        transform: none !important;
        min-height: 100vh;
        /* Ensure full page height for print */
      }

      .no-print {
        display: none !important;
      }

      @page {
        margin: 0;
        size: A4 portrait;
      }
    }
  </style>
</head>

<body>

  <div class="app-container">

    <div class="controls">
      <div class="section-title">
        <span style="font-size:24px">üìù</span> Bill Details
        <div style="margin-left:auto; font-size:12px; font-weight:normal; display:flex; gap:8px; align-items:center">
          <span id="invoiceModeLabel">Auto No. ON</span>
          <button onclick="resetInvoiceCount()"
            style="padding:4px 8px; font-size:10px; border:1px solid #ccc; background:#eee; border-radius:4px">Reset</button>
        </div>
      </div>

      <div class="form-group">
        <label>Patient Name</label>
        <input id="patientNameInput" type="text" placeholder="Enter patient name">
      </div>

      <div class="form-row">
        <div>
          <label>Invoice No. (Auto)</label>
          <input id="invoiceNoInput" type="text" placeholder="Auto" readonly
            style="background:#eef2f6; cursor:not-allowed">
        </div>
        <div>
          <label>Date</label>
          <input id="dateInput" type="date">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Age / Gender</label>
          <input id="ageGenderInput" type="text" placeholder="e.g. 54 Y / F">
        </div>
        <div>
          <label>Ref. By</label>
          <input id="refby" type="text" value="Dr. ">
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin: 24px 0;">

      <div class="section-title">
        <span style="font-size:24px">‚ûï</span> Add Services
      </div>

      <div class="add-item-box">
        <div class="form-group">
          <label>Service / Test Name</label>
          <input id="itemName" type="text" placeholder="Type to search test..." autocomplete="off">
          <div id="suggestionsList" class="suggestions-list"></div>
        </div>
        <div class="form-row">
          <div>
            <label>Price (‚Çπ)</label>
            <input id="itemPrice" type="number" placeholder="0">
          </div>
          <div>
            <label>Qty</label>
            <input id="itemQty" type="number" value="1">
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:12px" onclick="addItem()">Add to Bill</button>
      </div>

      <div class="action-bar">
        <button class="btn btn-success" onclick="renderInvoice()">üîÑ Update View</button>
        <button class="btn btn-secondary" onclick="clearForm()">‚úï Clear All</button>
        <button class="btn btn-dark full-width" onclick="exportPDF()">‚¨á Download PDF</button>
        <button class="btn btn-secondary full-width" onclick="printInvoice()">üñ® Print Bill</button>
      </div>
    </div>

    <div class="invoice-preview-wrapper" id="previewWrapper">
      <div class="zoom-controls">
        <span>Preview Mode (Auto-Fit)</span>
      </div>
      <div id="invoice" class="invoice">

        <div class="header">
          <img src="img/dr lal.jpg" alt="Logo">
          <div class="header-info">
            <h1>R. S. PATHO LAB</h1>
            <span>Collection Center</span>
            <p>LBSM College Road, Harharguttu, Near Shiv Mandir, Jamshedpur</p>
            <p><strong>Mobile:</strong> 8210236683, 9334757725 &nbsp;|&nbsp; <strong>Email:</strong>
              vishanup007@gmail.com</p>
          </div>
        </div>

        <div class="meta-grid">
          <div>Invoice No: <span id="inv_no">---</span></div>
          <div>Date: <span id="inv_date">---</span></div>
        </div>

        <div class="patient-details">
          <p><strong>Bill To:</strong> <span id="p_name">---</span></p>
          <p><strong>Ref By:</strong> <span id="ref_by">---</span></p>
          <p><strong>Age/Sex:</strong> <span id="p_age">---</span></p>
        </div>

        <table class="items" id="itemsTable">
          <thead>
            <tr>
              <th class="col-desc">Description</th>
              <th class="col-rate">Rate</th>
              <th class="col-qty">Qty</th>
              <th class="col-amt">Amount</th>
              <th class="col-act no-print">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- WRAPPER FOR BOTTOM SECTION TO PUSH IT DOWN -->
        <div class="invoice-bottom">
          <div class="totals-section">
            <table class="totals-table">
              <tr>
                <td>Sub Total</td>
                <td class="right">‚Çπ <span id="subTotal">0.00</span></td>
              </tr>
              <tr>
                <td style="font-weight:bold; font-size:16px;">Grand Total</td>
                <td class="right" style="font-weight:bold; font-size:16px;">‚Çπ <span id="grandTotal">0.00</span></td>
              </tr>
            </table>
          </div>

          <div class="qr-section">
            <img src="img/qr.jpg" alt="QR Code">
            <div class="qr-text">
              <p>UPI ID: 9097956657@ybl</p>
              <p>Preferred: PhonePe / GPay / Paytm</p>
              <p style="font-weight:normal; font-size:11px; color:#555; margin-top:5px">Scan to pay directly</p>
            </div>
          </div>

          <div class="inv-footer">
            <div class="inv-footer-content"
              style="display:flex; justify-content:space-between; align-items:flex-end; width:100%">
              <div style="font-style:italic; color:#555;">Thank you for your visit. Get well soon!</div>
              <div style="text-align:center">
                Authorised Signatory<br><br>
                _______________________
              </div>
            </div>
          </div>
          <div style="text-align:center; font-size:10px; color:#ccc; margin-top:10px;">‚ú® Created by Swayamv ‚ú®</div>
        </div> <!-- End invoice-bottom -->

      </div>
    </div>
  </div>

  <script>
    const labTests = [
      { name: "CBC (Complete Blood Count)", price: 350 },
      { name: "Blood Sugar (Fasting)", price: 100 },
      { name: "Blood Sugar (PP)", price: 100 },
      { name: "Blood Sugar (Random)", price: 100 },
      { name: "Lipid Profile", price: 650 },
      { name: "Liver Function Test (LFT)", price: 700 },
      { name: "Kidney Function Test (KFT)", price: 700 },
      { name: "Thyroid Profile (T3, T4, TSH)", price: 500 },
      { name: "TSH Only", price: 250 },
      { name: "HbA1c", price: 500 },
      { name: "Urine Routine", price: 150 },
      { name: "Urine Culture", price: 600 },
      { name: "Dengue NS1 Antigen", price: 800 },
      { name: "Malaria Parasite (Slide)", price: 150 },
      { name: "Widal Test (Typhoid)", price: 250 },
      { name: "Vitamin D Total", price: 1200 },
      { name: "Vitamin B12", price: 900 },
      { name: "Iron Studies", price: 800 },
      { name: "Calcium", price: 200 },
      { name: "Uric Acid", price: 200 }
    ];

    let items = [];

    window.addEventListener('load', () => {
      const dateInput = document.getElementById('dateInput');
      if (!dateInput.value) dateInput.value = new Date().toISOString().slice(0, 10);
      initInvoiceNumber();
      renderInvoice();
      handleResize();
      window.addEventListener('resize', handleResize);
      document.addEventListener('click', (e) => {
        const wrapper = document.querySelector('.form-group');
        if (!wrapper.contains(e.target)) {
          document.getElementById('suggestionsList').classList.remove('active');
        }
      });
    });

    const nameInput = document.getElementById('itemName');
    const suggestionsList = document.getElementById('suggestionsList');

    nameInput.addEventListener('input', function () {
      const val = this.value.toLowerCase();
      suggestionsList.innerHTML = '';

      if (val.length < 1) {
        suggestionsList.classList.remove('active');
        return;
      }
      const matches = labTests.filter(t => t.name.toLowerCase().includes(val));
      if (matches.length > 0) {
        matches.forEach(test => {
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.innerHTML = `<strong>${test.name}</strong> <span class="suggestion-price">‚Çπ ${test.price}</span>`;
          div.onclick = () => selectTest(test);
          suggestionsList.appendChild(div);
        });
        suggestionsList.classList.add('active');
      } else {
        suggestionsList.classList.remove('active');
      }
    });

    function selectTest(test) {
      document.getElementById('itemName').value = test.name;
      document.getElementById('itemPrice').value = test.price;
      suggestionsList.classList.remove('active');
    }

    function handleResize() {
      const wrapper = document.getElementById('previewWrapper');
      const invoice = document.getElementById('invoice');
      const INVOICE_WIDTH = 800;
      const PADDING = 40;
      const availableWidth = wrapper.clientWidth - PADDING;
      let scale = availableWidth / INVOICE_WIDTH;
      if (scale > 1) scale = 1;
      invoice.style.transform = `scale(${scale})`;
      const currentHeight = invoice.scrollHeight;
      invoice.style.marginBottom = `-${currentHeight * (1 - scale)}px`;
    }

    function initInvoiceNumber() {
      let lastNo = localStorage.getItem('lastInvoiceNo');
      if (!lastNo) lastNo = 0;
      const nextNo = parseInt(lastNo) + 1;
      document.getElementById('invoiceNoInput').value = nextNo;
    }

    function commitInvoiceNumber() {
      const current = document.getElementById('invoiceNoInput').value;
      if (current) localStorage.setItem('lastInvoiceNo', current);
    }

    function resetInvoiceCount() {
      if (confirm('Reset Invoice Counter to 0?')) {
        localStorage.setItem('lastInvoiceNo', 0);
        document.getElementById('invoiceNoInput').value = 1;
        renderInvoice();
      }
    }

    function addItem() {
      const nameInput = document.getElementById('itemName');
      const priceInput = document.getElementById('itemPrice');
      const qtyInput = document.getElementById('itemQty');
      const name = nameInput.value.trim();
      const price = parseFloat(priceInput.value) || 0;
      const qty = parseFloat(qtyInput.value) || 1;
      if (!name) { alert('Please select or enter a service name.'); return; }
      items.push({ desc: name, rate: price, qty: qty });
      nameInput.value = ''; priceInput.value = ''; qtyInput.value = 1; nameInput.focus();
      renderItems(); renderInvoice();
    }

    function removeItem(index) {
      if (confirm('Remove this item?')) {
        items.splice(index, 1); renderItems(); renderInvoice();
      }
    }

    function renderItems() {
      const tbody = document.querySelector('#itemsTable tbody');
      tbody.innerHTML = '';
      items.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td class="col-desc">${escapeHtml(item.desc)}</td>
        <td class="col-rate">${formatMoney(item.rate)}</td>
        <td class="col-qty">${item.qty}</td>
        <td class="col-amt">${formatMoney(item.rate * item.qty)}</td>
        <td class="col-act no-print">
          <button onclick="removeItem(${index})" style="background:#fee2e2; color:#ef4444; border:none; padding:4px 8px; border-radius:4px; font-weight:bold; cursor:pointer;">‚úï</button>
        </td>
      `;
        tbody.appendChild(tr);
      });
      calculateTotals();
      // Re-calculate margins after render
      setTimeout(handleResize, 100);
    }

    function calculateTotals() {
      const total = items.reduce((sum, item) => sum + (item.rate * item.qty), 0);
      document.getElementById('subTotal').innerText = formatMoney(total);
      document.getElementById('grandTotal').innerText = formatMoney(total);
    }

    function renderInvoice() {
      const getText = (id) => document.getElementById(id).value || '---';
      document.getElementById('p_name').innerText = getText('patientNameInput');
      document.getElementById('inv_no').innerText = getText('invoiceNoInput');
      document.getElementById('p_age').innerText = getText('ageGenderInput');
      document.getElementById('inv_date').innerText = getText('dateInput');
      document.getElementById('ref_by').innerText = getText('refby');
      renderItems();
    }

    function clearForm() {
      if (confirm('Start a new bill?')) {
        const current = parseInt(document.getElementById('invoiceNoInput').value);
        localStorage.setItem('lastInvoiceNo', current);
        document.getElementById('invoiceNoInput').value = current + 1;
        document.getElementById('patientNameInput').value = '';
        document.getElementById('ageGenderInput').value = '';
        document.getElementById('itemName').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemQty').value = 1;
        items = [];
        renderInvoice();
      }
    }

    function printInvoice() {
      renderInvoice();
      commitInvoiceNumber();
      window.print();
    }

    function exportPDF() {
      renderInvoice();
      commitInvoiceNumber();
      const element = document.getElementById('invoice');

      // Config for PDF
      const opt = {
        margin: 0,
        filename: `Invoice-${document.getElementById('invoiceNoInput').value}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        // FIX: Force desktop width AND sufficient height to capture full A4 on mobile
        html2canvas: { scale: 2, useCORS: true, windowWidth: 1200, windowHeight: 1600, scrollY: 0 },
        jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
      };

      // Pre-export cleanup
      const noPrintEls = element.querySelectorAll('.no-print');
      noPrintEls.forEach(el => el.style.display = 'none');

      // Store original styles
      const originalShadow = element.style.boxShadow;
      const originalTransform = element.style.transform;
      const originalMinHeight = element.style.minHeight;
      const originalHeight = element.style.height; // Store original height
      const originalMargin = element.style.margin;

      // Apply PDF-specific styles (Reset zoom, flattening)
      element.style.boxShadow = 'none';
      element.style.transform = 'none';
      element.style.margin = '0 auto';
      // FORCE A4 Height so footer sits at bottom with space in middle
      element.style.minHeight = '1123px';
      element.style.height = '1123px'; // Rigid height logic

      html2pdf().set(opt).from(element).save().then(() => {
        // Restore styles
        noPrintEls.forEach(el => el.style.display = '');
        element.style.boxShadow = originalShadow;
        element.style.transform = originalTransform;
        element.style.minHeight = originalMinHeight;
        element.style.height = 'auto'; // Reset height
        element.style.margin = originalMargin;
      });
    }

    const formatMoney = (v) => Number(v).toFixed(2);
    const escapeHtml = (text) => text.replace(/[&<>\"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[c]));

  </script>
</body>

</html>